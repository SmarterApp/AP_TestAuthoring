/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 * 
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/
package org.opentestsystem.authoring.testauth.publish;

import java.util.List;

import org.joda.time.DateTime;
import org.opentestsystem.authoring.testauth.domain.Assessment;
import org.opentestsystem.authoring.testauth.domain.ScoringRule;
import org.opentestsystem.authoring.testauth.publish.domain.Purpose;
import org.opentestsystem.authoring.testauth.publish.domain.PurposeBaseContent;
import org.opentestsystem.authoring.testauth.publish.domain.Scoring;
import org.opentestsystem.authoring.testauth.publish.domain.TestSpecification;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;

@Component("scoringPublisherHelper")
public class ScoringPublisherHelper extends BasePublisherHelper implements PublisherHelper {
    private static final Logger LOGGER = LoggerFactory.getLogger(ScoringPublisherHelper.class);

    @Autowired
    @Qualifier("administrationPublisherHelper")
    private PublisherHelper administrationPublisherHelper;

    @Override
    public TestSpecification<Scoring> createTestSpec(final Assessment assessment, final DateTime publishDate, final String version, final Purpose purpose,
            TestSpecification<? extends PurposeBaseContent> seedingTestSpec) {
        final long start = System.currentTimeMillis();
        final long dataRetrieval = System.currentTimeMillis();
        long performanceCreation = System.currentTimeMillis(), scoringCreation = System.currentTimeMillis();
        final TestSpecification<Scoring> testSpec = doGeneralTestSpecificationSetup(assessment, publishDate, version, purpose, Scoring.class);

        final boolean seedIsComplete = seedingTestSpec != null && seedingTestSpec.getComplete() != null;
        boolean seedIsAdmin = seedingTestSpec != null && seedingTestSpec.getAdministration() != null;
        if (seedingTestSpec == null) {
            seedingTestSpec = this.administrationPublisherHelper.createTestSpec(assessment, publishDate, version, purpose, null);
            seedIsAdmin = true;
        }
        final Scoring specContent = seedIsComplete ? new Scoring(seedingTestSpec.getComplete()) : seedIsAdmin ? new Scoring(seedingTestSpec.getAdministration()) : new Scoring();

        if (!seedIsComplete) {
            final String assessmentId = assessment.getId();

            // PERFORMANCE LEVELS
            specContent.setTestPerformanceLevelList(setupPerformanceLevelData(assessmentId, specContent.getBlueprintReferenceMap()));
            performanceCreation = System.currentTimeMillis();

            // SCORING RULES
            final List<ScoringRule> scoringRuleList = retrieveScoringRules(assessmentId);
            specContent.setScoringRuleData(setupScoringRuleData(assessmentId, specContent.getBlueprintReferenceMap(), scoringRuleList, specContent.getBlueprintElementList(), true));
            scoringCreation = System.currentTimeMillis();
        }

        if (LOGGER.isDebugEnabled()) {
            LOGGER.debug("data retrieval: " + (dataRetrieval - start) + "ms\n" +
                    "performance level: " + (performanceCreation - dataRetrieval) + "ms\n" +
                    "scoring rule: " + (scoringCreation - performanceCreation) + "ms\n" +
                    "total time: " + (System.currentTimeMillis() - start) + "ms");
        }

        testSpec.setContent(specContent);
        return testSpec;
    }
}
