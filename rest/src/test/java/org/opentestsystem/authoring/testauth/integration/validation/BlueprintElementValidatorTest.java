/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 * 
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/
package org.opentestsystem.authoring.testauth.integration.validation;

import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.MatcherAssert.assertThat;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;

import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.authoring.testauth.domain.Assessment;
import org.opentestsystem.authoring.testauth.domain.BlueprintElement;
import org.opentestsystem.authoring.testauth.domain.DomainFactory;
import org.opentestsystem.authoring.testauth.domain.ItemSelectionAlgorithm;
import org.opentestsystem.authoring.testauth.domain.ItemSelectionPurpose;
import org.opentestsystem.authoring.testauth.domain.ItemSelectionType;
import org.opentestsystem.authoring.testauth.domain.Publication;
import org.opentestsystem.authoring.testauth.domain.Segment;
import org.opentestsystem.authoring.testauth.domain.Subject;
import org.opentestsystem.authoring.testauth.rest.AbstractRestEmbeddedMongoTest;
import org.opentestsystem.authoring.testauth.service.AssessmentService;
import org.opentestsystem.authoring.testauth.service.ItemSelectionAlgorithmService;
import org.opentestsystem.authoring.testauth.service.PublicationService;
import org.opentestsystem.authoring.testauth.service.SegmentService;
import org.opentestsystem.authoring.testauth.service.SubjectService;
import org.opentestsystem.authoring.testauth.validation.BlueprintElementValidator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BeanPropertyBindingResult;
import org.springframework.validation.Errors;
import org.springframework.validation.FieldError;

import com.google.common.collect.ImmutableSet;

public class BlueprintElementValidatorTest extends AbstractRestEmbeddedMongoTest {

    @Autowired
    private ItemSelectionAlgorithmService itemSelectionAlgorithmService;

    @Autowired
    private SegmentService segmentService;

    @Autowired
    private SubjectService subjectService;

    @Autowired
    private PublicationService publicationService;

    @Autowired
    private AssessmentService assessmentService;

    @Autowired
    private BlueprintElementValidator blueprintElementValidator;

    private Assessment savedAssessment = null;

    private Segment booleanSegment = null;
    private Segment integerSegment = null;
    private Segment floatSegment = null;
    private Segment listSegment = null;

    @Before
    public void setupTestData() {
        final Subject savedSubject = this.subjectService.saveSubject(DomainFactory.manufactureValidSubject("abb"));
        final Publication savedPublication = this.publicationService.savePublication(DomainFactory.manufactureValidPublication(savedSubject.getTenantId(), ImmutableSet.of(savedSubject)));
        this.savedAssessment = this.assessmentService.saveAssessment(DomainFactory.manufactureValidAssessment(savedSubject, savedPublication));

        final ItemSelectionAlgorithm booleanAlgorithm = this.itemSelectionAlgorithmService.createItemSelectionAlgorithm(
                DomainFactory.manufactureValidItemSelectionAlgorithm(ItemSelectionPurpose.BLUEPRINT, ItemSelectionType.BOOLEAN));
        this.booleanSegment = DomainFactory.manufactureValidSegment(this.savedAssessment.getId(), booleanAlgorithm, 1);
        this.booleanSegment.setPosition(1);
        this.booleanSegment = this.segmentService.createSegment(this.booleanSegment);

        final ItemSelectionAlgorithm integerAlgorithm = this.itemSelectionAlgorithmService.createItemSelectionAlgorithm(
                DomainFactory.manufactureValidItemSelectionAlgorithm(ItemSelectionPurpose.BLUEPRINT, ItemSelectionType.INTEGER));
        this.integerSegment = DomainFactory.manufactureValidSegment(this.savedAssessment.getId(), integerAlgorithm, 2);
        this.integerSegment.setPosition(2);
        this.integerSegment = this.segmentService.createSegment(this.integerSegment);

        final ItemSelectionAlgorithm floatAlgorithm = this.itemSelectionAlgorithmService
                .createItemSelectionAlgorithm(DomainFactory.manufactureValidItemSelectionAlgorithm(ItemSelectionPurpose.BLUEPRINT, ItemSelectionType.FLOAT));
        this.floatSegment = DomainFactory.manufactureValidSegment(this.savedAssessment.getId(), floatAlgorithm, 3);
        this.floatSegment.setPosition(3);
        this.floatSegment = this.segmentService.createSegment(this.floatSegment);

        final ItemSelectionAlgorithm listAlgorithm = this.itemSelectionAlgorithmService.createItemSelectionAlgorithm(
                DomainFactory.manufactureValidItemSelectionAlgorithm(ItemSelectionPurpose.BLUEPRINT, ItemSelectionType.LIST));
        this.listSegment = DomainFactory.manufactureValidSegment(this.savedAssessment.getId(), listAlgorithm, 4);
        this.listSegment.setPosition(4);
        this.listSegment = this.segmentService.createSegment(this.listSegment);
    }

    @Test
    public void validateBlueprintElement() {
        final BlueprintElement blueprintElement = DomainFactory.manufactureValidBlueprintElement("assessment-id", new HashSet<Segment>());

        final Errors errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(0));
    }

    @Test
    public void validateBlueprintElementWithMissingBasicFields() {
        final BlueprintElement blueprintElement = DomainFactory.manufactureValidBlueprintElement("", new HashSet<Segment>());
        blueprintElement.setStandardKey(null);
        blueprintElement.setLevel(null);
        blueprintElement.setGrade(null);

        final Errors errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);

        assertThat(errors.getAllErrors().size(), is(4));
        assertThat(getErrorsForCode(errors, "assessmentId.required").size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.standard.required").size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.level.required").size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.grade.required").size(), is(1));
    }

    @Test
    public void validateBlueprintElementWithBooleanParameter() {
        final BlueprintElement blueprintElement = DomainFactory.manufactureValidBlueprintElement(this.savedAssessment.getId(),
                ImmutableSet.of(booleanSegment, integerSegment, floatSegment, listSegment));

        blueprintElement.getBlueprintElementValueMap().get(this.booleanSegment.getId()).getItemSelectionParameters().clear();
        Errors errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.count").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.booleanSegment.getId()).getItemSelectionParameters().put("invalid-param-name", "invalid-boolean");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.required").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.booleanSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.booleanSegment.getId()).getItemSelectionParameters()
                .put(this.booleanSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "invalid-boolean");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.invalid").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.booleanSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.booleanSegment.getId()).getItemSelectionParameters()
                .put(this.booleanSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "false");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(0));
    }

    @Test
    public void validateBlueprintElementWithIntegerParameter() {
        final BlueprintElement blueprintElement = DomainFactory.manufactureValidBlueprintElement(this.savedAssessment.getId(),
                ImmutableSet.of(booleanSegment, integerSegment, floatSegment, listSegment));

        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters().clear();
        Errors errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.count").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters().put("invalid-param-name", "invalid-integer");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.required").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters()
                .put(this.integerSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "invalid-integer");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.parseable.number").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters()
                .put(this.integerSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "5.5");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.parseable.number").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters()
                .put(this.integerSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "999");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.out.of.range").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters()
                .put(this.integerSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "-999");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.out.of.range").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.integerSegment.getId()).getItemSelectionParameters()
                .put(this.integerSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "5");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(0));
    }

    @Test
    public void validateBlueprintElementWithFloatParameter() {
        final BlueprintElement blueprintElement = DomainFactory.manufactureValidBlueprintElement(this.savedAssessment.getId(),
                ImmutableSet.of(booleanSegment, integerSegment, floatSegment, listSegment));

        blueprintElement.getBlueprintElementValueMap().get(this.floatSegment.getId()).getItemSelectionParameters().clear();
        Errors errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.count").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.floatSegment.getId()).getItemSelectionParameters().put("invalid-param-name", "invalid-float");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.required").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.floatSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.floatSegment.getId()).getItemSelectionParameters()
                .put(this.floatSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "invalid-float");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.parseable.number").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.floatSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.floatSegment.getId()).getItemSelectionParameters()
                .put(this.floatSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "999");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.out.of.range").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.floatSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.floatSegment.getId()).getItemSelectionParameters()
                .put(this.floatSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "-999");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.out.of.range").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.floatSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.floatSegment.getId()).getItemSelectionParameters()
                .put(this.floatSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "5.5");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(0));
    }

    @Test
    public void validateBlueprintElementWithListParameter() {
        final BlueprintElement blueprintElement = DomainFactory.manufactureValidBlueprintElement(this.savedAssessment.getId(),
                ImmutableSet.of(booleanSegment, integerSegment, floatSegment, listSegment));

        blueprintElement.getBlueprintElementValueMap().get(this.listSegment.getId()).getItemSelectionParameters().clear();
        Errors errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.count").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.listSegment.getId()).getItemSelectionParameters().put("invalid-param-name", "invalid-list");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.required").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.listSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.listSegment.getId()).getItemSelectionParameters()
                .put(this.listSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), "invalid-list");
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(1));
        assertThat(getErrorsForCode(errors, "blueprintElement.blueprintElementValueMap.itemSelectionParameters.invalid.selection").size(), is(1));

        blueprintElement.getBlueprintElementValueMap().get(this.listSegment.getId()).getItemSelectionParameters().clear();
        blueprintElement.getBlueprintElementValueMap().get(this.listSegment.getId()).getItemSelectionParameters()
                .put(this.listSegment.getItemSelectionAlgorithm().getParameters().get(0).getParameterName(), this.listSegment.getItemSelectionAlgorithm().getParameters().get(0).getDefaultValue());
        errors = new BeanPropertyBindingResult(blueprintElement, "blueprintElement");
        this.blueprintElementValidator.validate(blueprintElement, errors);
        assertThat(errors.getAllErrors().size(), is(0));
    }

    private static List<FieldError> getErrorsForCode(final Errors errors, final String messageCode) {
        final List<FieldError> fieldErrors = new ArrayList<FieldError>();
        for (final FieldError fieldError : errors.getFieldErrors()) {
            if (fieldError.getDefaultMessage().equals(messageCode)) {
                fieldErrors.add(fieldError);
            }
        }
        return fieldErrors;
    }
}
